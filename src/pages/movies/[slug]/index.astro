---
import { Image } from 'astro:assets';
import { BookImage, ChevronRight } from 'lucide-astro';

import { DiscTitles } from '~/components/DiscTitles';
import { getImageUrl } from '~/utils/image';
import { query } from '~/graphql';
import Layout from '~/layouts/Layout.astro';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/movies');

const { mediaItems } = await query.GetMovieBySlug({ slug });
const movie = mediaItems?.edges?.[0]?.node;
if (!movie) return Astro.redirect('/movies');

const image = getImageUrl(movie.imageUrl);

const description = movie.plot
	? movie.plot.substring(0, 155) + (movie.plot.length > 155 ? '...' : '')
	: `View detailed information about ${movie.title ?? 'this movie'} including physical releases, disc contents, and specifications.`;

Astro.response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=30');
---

<Layout
	title={`${movie.title ?? 'Movie'} - TheDiscDB`}
	description={description}
>
	<div class="max-w-7xl mx-auto">
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
			<!-- Poster -->
			<div class="lg:col-span-1">
				<div class="aspect-2/3 image-container rounded-md overflow-hidden sticky top-8">
					{image ? (
						<Image
							alt={movie.title ?? 'Movie poster'}
							class="w-full rounded-md border border-zinc-200 dark:border-zinc-800"
							height={900}
							src={image}
							transition:name={`poster-${slug}`}
							width={600}
						/>
					) : (
						<div class="w-full h-full flex items-center justify-center text-zinc-400">
							No Image
						</div>
					)}
				</div>
			</div>

			<!-- Details -->
			<div class="lg:col-span-2">
				<h1 class="text-4xl font-bold mb-4">{movie.title}</h1>

				{movie.tagline && (
					<p class="text-xl text-zinc-600 dark:text-zinc-400 italic mb-6">
						{movie.tagline}
					</p>
				)}

				<div class="flex flex-wrap gap-4 mb-6 text-sm">
					{movie.year && (
						<div class="px-3 py-1 bg-zinc-100 dark:bg-zinc-800 rounded">
							{movie.year}
						</div>
					)}
					{movie.contentRating && (
						<div class="px-3 py-1 bg-zinc-100 dark:bg-zinc-800 rounded">
							{movie.contentRating}
						</div>
					)}
					{movie.runtimeMinutes && (
						<div class="px-3 py-1 bg-zinc-100 dark:bg-zinc-800 rounded">
							{Math.floor(movie.runtimeMinutes / 60)}h {movie.runtimeMinutes % 60}m
						</div>
					)}
				</div>

				{movie.genres && (
					<div class="mb-6">
						<h2 class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">GENRES</h2>
						<p>{movie.genres}</p>
					</div>
				)}

				{movie.plot && (
					<div class="mb-6">
						<h2 class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">PLOT</h2>
						<p class="text-zinc-700 dark:text-zinc-300">{movie.plot}</p>
					</div>
				)}

				{movie.directors && (
					<div class="mb-6">
						<h2 class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">DIRECTORS</h2>
						<p>{movie.directors}</p>
					</div>
				)}

				{movie.stars && (
					<div class="mb-6">
						<h2 class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">STARS</h2>
						<p>{movie.stars}</p>
					</div>
				)}

				{movie.writers && (
					<div class="mb-6">
						<h2 class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">WRITERS</h2>
						<p>{movie.writers}</p>
					</div>
				)}

				{movie.externalids && (
					<div class="mb-6">
						<h2 class="text-sm font-semibold text-zinc-600 dark:text-zinc-400 mb-2">EXTERNAL IDS</h2>
						<div class="flex gap-4">
							{movie.externalids.imdb && (
								<a
									href={`https://www.imdb.com/title/${movie.externalids.imdb}`}
									target="_blank"
									rel="noopener noreferrer"
									class="text-blue-600 dark:text-blue-400 hover:underline"
								>
									IMDb
								</a>
							)}
							{movie.externalids.tmdb && (
								<a
									href={`https://www.themoviedb.org/movie/${movie.externalids.tmdb}`}
									target="_blank"
									rel="noopener noreferrer"
									class="text-blue-600 dark:text-blue-400 hover:underline"
								>
									TMDb
								</a>
							)}
							{movie.externalids.tvdb && (
								<a
									href={`https://www.thetvdb.com/?id=${movie.externalids.tvdb}&tab=series`}
									target="_blank"
									rel="noopener noreferrer"
									class="text-blue-600 dark:text-blue-400 hover:underline"
								>
									TVDb
								</a>
							)}
						</div>
					</div>
				)}
			</div>
		</div>

		<!-- Releases -->
		{movie.releases && movie.releases.length > 0 && (
			<div class="mt-12">
				<h2 class="inline-flex items-center gap-2 text-2xl font-bold mb-6">
					<BookImage />
					<span>Releases</span>
				</h2>
				<div class="space-y-8">
					{movie.releases.map((release) => (
						<div class="border border-zinc-200 dark:border-zinc-800 rounded-md p-6">
							<div class="flex gap-6 mb-6">
								{release.imageUrl && getImageUrl(release.imageUrl) && (
									<div class="w-32 shrink-0 image-container rounded">
										<Image
											src={getImageUrl(release.imageUrl)!}
											alt={release.title ?? 'Release cover'}
											width={128}
											height={192}
											class="w-full rounded"
										/>
									</div>
								)}
								<div class="flex-1">
									<h3 class="text-xl font-semibold mb-2">{release.title}</h3>
									<div class="grid grid-cols-2 gap-4 text-sm">
										{release.year && (
											<div>
												<span class="text-zinc-600 dark:text-zinc-400">Year:</span> {release.year}
											</div>
										)}
										{release.regionCode && (
											<div>
												<span class="text-zinc-600 dark:text-zinc-400">Region:</span> {release.regionCode}
											</div>
										)}
										{release.locale && (
											<div>
												<span class="text-zinc-600 dark:text-zinc-400">Locale:</span> {release.locale}
											</div>
										)}
										{release.upc && (
											<div>
												<span class="text-zinc-600 dark:text-zinc-400">UPC:</span> {release.upc}
											</div>
										)}
										{release.isbn && (
											<div>
												<span class="text-zinc-600 dark:text-zinc-400">ISBN:</span> {release.isbn}
											</div>
										)}
										{release.asin && (
											<div>
												<span class="text-zinc-600 dark:text-zinc-400">ASIN:</span> {release.asin}
											</div>
										)}
									</div>
								</div>
							</div>

							{/* Discs */}
							{release.discs && release.discs.length > 0 && (
								<div class="mt-6">
									<h4 class="font-semibold mb-4">Discs</h4>
									<div class="space-y-4">
										{release.discs.map((disc) => (
											<details class="bg-zinc-50 dark:bg-zinc-900 rounded group border border-zinc-200 dark:border-zinc-800">
												<summary class="inline-flex items-center justify-between gap-2 w-full p-4  font-medium cursor-pointer hover:text-zinc-600 dark:hover:text-zinc-400 default-transition">
													<div class="inline-flex items-center gap-2">
														<ChevronRight class="w-4 h-4 default-transition group-open:rotate-90" />
														<span>Disc {disc.index + 1}</span>
														|
														<span>{disc.name}</span>
													</div>

													<span class="inline-flex items-center rounded-md bg-blue-100 px-2 py-1 text-xs font-medium text-blue-700 dark:bg-blue-400/10 dark:text-blue-400">
														{disc.format}
													</span>
												</summary>
												
												{disc.titles && disc.titles.length > 0 && (
													<div class="p-4">
														<DiscTitles titles={disc.titles} type="movie" client:load />
													</div>
												)}
											</details>
										))}
									</div>
								</div>
							)}
						</div>
					))}
				</div>
			</div>
		)}
	</div>
</Layout>
